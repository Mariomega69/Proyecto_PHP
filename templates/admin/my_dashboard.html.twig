{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}Panel de Control BMW - Estadísticas Globales{% endblock %}

{% block main %}
    <style>
        .dashboard-card { border-radius: 10px; border: none; transition: transform 0.2s; }
        .dashboard-card:hover { transform: translateY(-5px); }
        .stat-bg-dark { background-color: #1a1d21; color: white; border: 1px solid #343a40; }
        .list-group-item { background: transparent; color: #ddd; border-color: #343a40; }

        /* Estilos Consenso Tier List */
        .tier-list-container { border: 2px solid #0dcaf0 !important; }
        .form-select-custom {
            background-color: #1a1d21 !important;
            color: #fff !important;
            border: 1px solid #0dcaf0 !important;
            border-radius: 8px;
        }
    </style>

    {# Fila de Tarjetas Superiores #}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white dashboard-card shadow-sm">
                <div class="card-body text-center p-4">
                    <h2 class="fw-bold">{{ totalMotos }}</h2>
                    <p class="mb-0 small"><i class="fas fa-motorcycle"></i> Motos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white dashboard-card shadow-sm">
                <div class="card-body text-center p-4">
                    <h2 class="fw-bold">{{ totalValoraciones }}</h2>
                    <p class="mb-0 small"><i class="fas fa-star"></i> Valoraciones</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white dashboard-card shadow-sm">
                <div class="card-body text-center p-4">
                    <h2 class="fw-bold">{{ totalCategorias }}</h2>
                    <p class="mb-0 small"><i class="fas fa-tags"></i> Categorías</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark dashboard-card shadow-sm">
                <div class="card-body text-center p-4">
                    <h2 class="fw-bold">{{ totalUsuarios }}</h2>
                    <p class="mb-0 small"><i class="fas fa-users"></i> Usuarios</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        {# Top 5 General #}
        <div class="col-md-4">
            <div class="card stat-bg-dark h-100 shadow">
                <div class="card-header border-secondary bg-transparent py-3">
                    <h5 class="card-title m-0 text-warning fw-bold"><i class="fas fa-medal me-2"></i>Top 5 General (Votos)</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for item in topMotos %}
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><span class="text-muted me-2">#{{ loop.index }}</span> {{ item.moto.modelo }}</span>
                                <span class="badge bg-warning text-dark">{{ item.media|number_format(1) }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        {# Consenso Tier List (Rankings) #}
        <div class="col-md-8">
            <div class="card stat-bg-dark h-100 shadow tier-list-container">
                <div class="card-header border-info bg-transparent py-3">
                    <h5 class="card-title m-0 text-info fw-bold"><i class="fas fa-layer-group me-2"></i>Consenso Tier List (Rankings)</h5>
                </div>
                <div class="card-body">
                    <select id="categoriaSelector" class="form-select form-select-custom mb-4 py-2">
                        <option value="">-- Ver Medias por Categoría --</option>
                        {% for cat in categorias %}
                            <option value="{{ cat.nombre }}">{{ cat.nombre }}</option>
                        {% endfor %}
                    </select>

                    <div id="tierListContent">
                        <div class="p-4 text-center border border-warning border-dashed rounded" style="border-style: dashed !important; background: rgba(255,193,7,0.05);">
                            <p class="text-warning mb-0">
                                <i class="fas fa-info-circle me-2"></i> Selecciona una categoría arriba para ver las medias de los rankings.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ path('admin_importar_motos') }}" class="btn btn-outline-info">
            <i class="fas fa-sync-alt me-1"></i> Forzar Sincronización API BMW
        </a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const selector = document.getElementById('categoriaSelector');
            const content = document.getElementById('tierListContent');
            const datosMotos = {{ todasLasMotos|json_encode|raw }};

            selector.addEventListener('change', function() {
                const categoria = this.value;
                if (!categoria) {
                    content.innerHTML = `
                        <div class="p-4 text-center border border-warning border-dashed rounded" style="border-style: dashed !important; background: rgba(255,193,7,0.05);">
                            <p class="text-warning mb-0"><i class="fas fa-info-circle me-2"></i> Selecciona una categoría.</p>
                        </div>`;
                    return;
                }

                // Filtrar y ordenar: En rankings, 1.00 es el mejor (S), 4.00 es el peor (C)
                const filtradas = datosMotos
                    .filter(m => m.categoriaNombre === categoria)
                    .sort((a, b) => a.media - b.media);

                if (filtradas.length === 0) {
                    content.innerHTML = '<p class="text-muted text-center p-4">No hay datos de rankings para esta categoría.</p>';
                    return;
                }

                let html = '<ul class="list-group list-group-flush">';
                filtradas.forEach(m => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2 border-bottom border-secondary">
                            <span class="text-white">${m.modelo}</span>
                            <span class="fw-bold" style="color: #0dcaf0; font-size: 1.1rem;">
                                ${parseFloat(m.media).toFixed(2)}
                            </span>
                        </li>`;
                });
                html += '</ul>';

                content.innerHTML = html;
            });
        });
    </script>
{% endblock %}

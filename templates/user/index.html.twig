{% extends 'base.html.twig' %}

{% block title %}Mi Cuenta - Panel Personal{% endblock %}

{% block body %}
    <style>
        /* Forzamos que el cuerpo no bloquee nada */
        body { background-color: #1a1d21; color: #ffffff; pointer-events: auto !important; }

        .dashboard-header { background-color: #212529; padding: 20px; border-bottom: 1px solid #343a40; }
        .stat-card { background-color: #2c3034; border-radius: 8px; padding: 20px; border-left: 5px solid #0d6efd; margin-bottom: 15px; }

        /* Contenedores de actividad */
        .activity-card { background-color: #2c3034; border-radius: 8px; padding: 20px; border: 1px solid #3e444a; height: 100%; }

        /* TierMaker Estático (Sin JS para evitar bloqueos) */
        .tier-container { background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 30px; border: 1px solid #444; }
        .tier-row { display: flex; border-bottom: 1px solid #222; min-height: 60px; }
        .tier-label { width: 60px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; flex-shrink: 0; }
        .bg-s { background-color: #ff7f7f; } .bg-a { background-color: #ffbf7f; } .bg-b { background-color: #ffff7f; } .bg-c { background-color: #bfff7f; }
        .tier-items { flex-grow: 1; display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: #1a1a1a; }
        .tier-item-box { background: #333; padding: 4px 10px; border-radius: 3px; font-size: 0.8rem; border: 1px solid #444; color: #eee; }

        /* Mensaje de aviso corregido */
        .mensaje-aviso {
            color: #ffc107 !important;
            background-color: rgba(255, 193, 7, 0.1);
            border: 1px dashed #ffc107;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        /* Asegurar que el formulario de selección funcione siempre */
        .form-select {
            cursor: pointer !important;
            position: relative;
            z-index: 100;
        }
    </style>

    <div class="dashboard-header mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <h2 class="fw-bold m-0 text-white">¡Hola, {{ user.nombre|default(user.email) }}!</h2>
            <div>
                <a href="{{ path('app_moto') }}" class="btn btn-sm btn-info fw-bold me-2 shadow-sm">Catálogo</a>
                <a href="{{ path('app_logout') }}" class="btn btn-sm btn-outline-danger">Salir</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row g-4 mb-5">
            {# ESTADÍSTICAS #}
            <div class="col-md-8">
                <div class="row g-3 mb-4">
                    <div class="col-6"><div class="stat-card"><h6>Motos: {{ stats.total_motos }}</h6></div></div>
                    <div class="col-6"><div class="stat-card" style="border-left-color: #ffc107;"><h6>Rankings: {{ misRankings|length }}</h6></div></div>
                </div>

                <div class="row g-4">
                    {# TOP COMUNIDAD #}
                    <div class="col-md-6">
                        <div class="activity-card border-top border-warning border-3">
                            <h6 class="text-warning fw-bold mb-3">Top Comunidad (Estrellas)</h6>
                            {% for item in topMotos %}
                                <div class="d-flex justify-content-between small border-bottom border-secondary mb-2 pb-1">
                                    <span>{{ item.moto.modelo }}</span>
                                    <span class="badge bg-warning text-dark">{{ item.media|number_format(1) }} ★</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    {# CONSENSO TIER LIST #}
                    <div class="col-md-6">
                        <div class="activity-card border-top border-info border-3">
                            <h6 class="text-info fw-bold mb-3">Consenso Tier List</h6>

                            <form method="get" action="{{ path('app_user_dashboard') }}" class="mb-3">
                                <select name="id_categoria_ranking" class="form-select form-select-sm bg-dark text-white border-info" onchange="this.form.submit()">
                                    <option value="">-- Ver Medias por Categoría --</option>
                                    {% for cat in categorias %}
                                        <option value="{{ cat.id }}" {{ idCatActual == cat.id ? 'selected' : '' }}>{{ cat.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </form>

                            {% if rankingPosicionesMedia is not empty %}
                                {% for item in rankingPosicionesMedia %}
                                    <div class="d-flex justify-content-between small border-bottom border-secondary mb-2 pb-1">
                                        <span>{{ item.modelo }}</span>
                                        <span class="fw-bold text-info">{{ item.mediaPosicion|number_format(2) }}</span>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="mensaje-aviso small">
                                    <i class="fas fa-info-circle me-1"></i> Selecciona una categoría arriba para ver las medias.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# ACCIONES #}
            <div class="col-md-4">
                <div class="bg-dark p-4 rounded border border-secondary shadow-lg">
                    <h6 class="text-white-50 mb-3 small fw-bold">GESTIÓN</h6>
                    <a href="{{ path('app_moto') }}" class="btn btn-primary w-100 mb-4 fw-bold shadow">IR AL CATÁLOGO</a>

                    <h6 class="text-white-50 mb-2 small fw-bold">CREAR NUEVO RANKING:</h6>
                    <div class="d-grid gap-2">
                        {% for cat in categorias %}
                            <a href="{{ path('app_ranking_nuevo', {'id': cat.id}) }}" class="btn btn-outline-warning btn-sm text-start">{{ cat.nombre }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {# RANKINGS #}
        <h4 class="mb-4 fw-bold text-white-50">Mis Rankings Guardados</h4>
        <div class="row">
            {% for ranking in misRankings %}
                <div class="col-md-6">
                    <div class="tier-container shadow-sm">
                        <div class="p-2 bg-dark border-bottom border-secondary small fw-bold text-info d-flex justify-content-between">
                            <span>{{ ranking.nombre }}</span>
                            <span class="text-white-50">{{ ranking.categoria.nombre }}</span>
                        </div>
                        {% for tier in ['S', 'A', 'B', 'C'] %}
                            <div class="tier-row">
                                <div class="tier-label bg-{{ tier|lower }}">{{ tier }}</div>
                                <div class="tier-items">
                                    {% for item in ranking.items|filter(i => i.tier == tier) %}
                                        <span class="tier-item-box">{{ item.moto.modelo }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

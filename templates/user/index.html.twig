{% extends 'base.html.twig' %}

{% block title %}Mi Cuenta - Panel Personal{% endblock %}

{% block body %}
    <style>
        body { background-color: #1a1d21; color: #ffffff; pointer-events: auto !important; }
        .dashboard-header { background-color: #212529; padding: 20px; border-bottom: 1px solid #343a40; }
        .stat-card { background-color: #2c3034; border-radius: 8px; padding: 20px; border-left: 5px solid #0d6efd; margin-bottom: 15px; }
        .activity-card { background-color: #2c3034; border-radius: 8px; padding: 20px; border: 1px solid #3e444a; height: 100%; }

        /* TierMaker Estático */
        .tier-container { background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 30px; border: 1px solid #444; }
        .tier-row { display: flex; border-bottom: 1px solid #222; min-height: 60px; }
        .tier-label { width: 60px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #000; flex-shrink: 0; }
        .bg-s { background-color: #ff7f7f; } .bg-a { background-color: #ffbf7f; } .bg-b { background-color: #ffff7f; } .bg-c { background-color: #bfff7f; }
        .tier-items { flex-grow: 1; display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background: #1a1a1a; }
        .tier-item-box { background: #333; padding: 4px 10px; border-radius: 3px; font-size: 0.8rem; border: 1px solid #444; color: #eee; }

        .mensaje-aviso { color: #ffc107 !important; background-color: rgba(255, 193, 7, 0.1); border: 1px dashed #ffc107; padding: 15px; border-radius: 5px; font-weight: bold; text-align: center; }
    </style>

    <div class="dashboard-header mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <h2 class="fw-bold m-0 text-white">¡Hola, {{ user.nombre|default(user.email) }}!</h2>
            <div>
                <a href="{{ path('app_moto') }}" class="btn btn-sm btn-info fw-bold me-2 shadow-sm">Catálogo</a>
                <a href="{{ path('app_logout') }}" class="btn btn-sm btn-outline-danger">Salir</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row g-4 mb-5">
            {# ESTADÍSTICAS Y TOPS #}
            <div class="col-md-8">
                <div class="row g-3 mb-4">
                    <div class="col-6"><div class="stat-card"><h6>Motos: {{ stats.total_motos }}</h6></div></div>
                    <div class="col-6"><div class="stat-card" style="border-left-color: #ffc107;"><h6>Rankings Hechos: {{ misRankings|length }}</h6></div></div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="activity-card border-top border-warning border-3 shadow-sm">
                            <h6 class="text-warning fw-bold mb-3">Top Comunidad (Estrellas)</h6>
                            {% for item in topMotos %}
                                <div class="d-flex justify-content-between small border-bottom border-secondary mb-2 pb-1">
                                    <span>{{ item.moto.modelo }}</span>
                                    <span class="badge bg-warning text-dark">{{ item.media|number_format(1) }} ★</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="activity-card border-top border-info border-3 shadow-sm">
                            <h6 class="text-info fw-bold mb-3">Consenso Tier List (Medias)</h6>
                            <form method="get" action="{{ path('app_user_dashboard') }}" class="mb-3">
                                <select name="id_categoria_ranking" class="form-select form-select-sm bg-dark text-white border-info" onchange="this.form.submit()">
                                    <option value="">-- Seleccionar Categoría --</option>
                                    {% for cat in categorias %}
                                        <option value="{{ cat.id }}" {{ idCatActual == cat.id ? 'selected' : '' }}>{{ cat.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                            {% if rankingPosicionesMedia is not empty %}
                                {% for item in rankingPosicionesMedia %}
                                    <div class="d-flex justify-content-between small border-bottom border-secondary mb-2 pb-1">
                                        <span>{{ item.modelo }}</span>
                                        <span class="fw-bold text-info">{{ item.mediaPosicion|number_format(2) }}</span>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="mensaje-aviso small">Selecciona una categoría para ver la media de posiciones.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# ACCIONES DINÁMICAS #}
            <div class="col-md-4">
                <div class="bg-dark p-4 rounded border border-secondary shadow-lg">
                    <h6 class="text-white-50 mb-3 small fw-bold text-uppercase">Mis Rankings</h6>
                    <div class="d-grid gap-2">
                        {% for cat in categorias %}
                            {% if mapaRankings[cat.id] is defined %}
                                <a href="{{ path('app_ranking_editar', {'id': mapaRankings[cat.id]}) }}" class="btn btn-outline-info btn-sm text-start d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-edit me-2"></i>{{ cat.nombre }}</span>
                                    <span class="badge bg-info text-dark">EDITAR</span>
                                </a>
                            {% else %}
                                <a href="{{ path('app_ranking_nuevo', {'id': cat.id}) }}" class="btn btn-outline-warning btn-sm text-start d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-plus me-2"></i>{{ cat.nombre }}</span>
                                    <span class="badge bg-warning text-dark">CREAR</span>
                                </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <hr class="text-secondary my-4">
                    <a href="{{ path('app_moto') }}" class="btn btn-primary w-100 fw-bold">CATÁLOGO COMPLETO</a>
                </div>
            </div>
        </div>

        {# LISTADO DE RANKINGS VISUALES #}
        <h4 class="mb-4 fw-bold text-white-50">Mis Rankings Guardados</h4>
        <div class="row">
            {% for ranking in misRankings %}
                <div class="col-md-6">
                    <div class="tier-container shadow-sm border-info">
                        <div class="p-2 bg-dark border-bottom border-secondary small fw-bold text-info d-flex justify-content-between align-items-center">
                            <span>{{ ranking.categoria.nombre }}</span>
                            <a href="{{ path('app_ranking_editar', {'id': ranking.id}) }}" class="btn btn-xxs btn-outline-info py-0 px-2" style="font-size: 0.7rem;">MODIFICAR</a>
                        </div>
                        {% for tier in ['S', 'A', 'B', 'C'] %}
                            <div class="tier-row">
                                <div class="tier-label bg-{{ tier|lower }}">{{ tier }}</div>
                                <div class="tier-items">
                                    {% for item in ranking.items|filter(i => i.tier == tier) %}
                                        <span class="tier-item-box">{{ item.moto.modelo }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
